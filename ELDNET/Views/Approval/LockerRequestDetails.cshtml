@model ELDNET.Models.LockerRequest

@{
    ViewData["Title"] = "Locker Request Details";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link href="~/css/Approval/Locker.css" rel="stylesheet" />
</head>

<div class="container py-5">
    <div class="modern-card animate__animated animate__fadeIn">
        <div class="glass-header d-flex justify-content-between align-items-center">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="#" class="text-white opacity-75 text-decoration-none">Locker Request</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Details</li>
                    </ol>
                </nav>
                <h2 class="fw-bold mb-0">LR-@Model.Id.ToString("D5")</h2>
                <span class="opacity-75"><i class="bi bi-calendar3 me-2"></i>Requested on @Model.Date.ToString("MMMM dd, yyyy")</span>
            </div>
            <div class="text-end">
                <div class="mb-2 opacity-75 small fw-bold">OVERALL STATUS</div>
                <span class="status-pill @(Model.Status == "Approved" ? "bg-success" : Model.Status == "Denied" ? "bg-danger" : "bg-warning text-dark")">
                    @Model.Status
                </span>
            </div>
        </div>

        <div class="card-body p-4 p-lg-5">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-person-badge text-primary"></i> Requestor Information</div>
                                <div class="row">
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Full Name</div>
                                        <div class="info-value">@Model.Name</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">ID Number</div>
                                        <div class="info-value">@Model.IdNumber</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Contact Number</div>
                                        <div class="info-value">@Model.ContactNumber</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Semester / Term</div>
                                        <div class="info-value">@Model.Semester</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-key-fill text-primary"></i> Locker Details</div>
                                <div class="row">
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Locker Number</div>
                                        <div class="info-value fw-bold text-primary">@Model.LockerNumber</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Terms Acceptance</div>
                                        <div class="info-value">@(Model.AcceptTerms ? "Accepted" : "Pending")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="data-section">
                        <div class="section-label"><i class="bi bi-paperclip text-primary"></i> Supporting Documents</div>
                        <div class="d-grid gap-2">
                            @if (!string.IsNullOrEmpty(Model.StudyLoadPath))
                            {
                                <a href="@Url.Content(Model.StudyLoadPath)" target="_blank" class="file-card">
                                    <i class="bi bi-file-earmark-text fs-4 me-3 text-primary"></i>
                                    <div>
                                        <div class="fw-bold small">Study Load</div>
                                        <div class="text-muted" style="font-size: 0.7rem;">View Attachment</div>
                                    </div>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Model.RegistrationPath))
                            {
                                <a href="@Url.Content(Model.RegistrationPath)" target="_blank" class="file-card">
                                    <i class="bi bi-card-checklist fs-4 me-3 text-primary"></i>
                                    <div>
                                        <div class="fw-bold small">Registration Form</div>
                                        <div class="text-muted" style="font-size: 0.7rem;">View Attachment</div>
                                    </div>
                                </a>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(Model.DenialReasonLocker))
                        {
                            <div class="mt-4 p-3 rounded-3 bg-danger-subtle border border-danger-subtle text-danger">
                                <div class="fw-bold small mb-1"><i class="bi bi-exclamation-octagon-fill"></i> REASON FOR DENIAL</div>
                                <div class="small">@Model.DenialReasonLocker</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="section-label mb-4"><i class="bi bi-ui-checks text-primary"></i> Approval Workflow & Actions</div>
                <div class="row g-4">
                    @{
                        var step = new { Name = Model.Approver1Name, Status = Model.Approver1Status, ID = 1 };
                        var cardClass = step.Status == "Approved" ? "approved" : (step.Status == "Denied" ? "denied" : "pending active-stage");
                        var statusIcon = step.Status == "Approved" ? "bi-check-circle-fill text-success" : (step.Status == "Denied" ? "bi-x-circle-fill text-danger" : "bi-clock-history text-warning");
                    }

                    <div class="col-md-4">
                        <div class="approver-card @cardClass shadow-sm">
                            <div class="stage-badge">STAGE @step.ID</div>
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi @statusIcon fs-4 me-2"></i>
                                <div class="fw-bold text-dark">@step.Name</div>
                            </div>

                            <div class="mb-3">
                                <span class="small text-muted d-block">Current Status:</span>
                                <span class="badge @(step.Status == "Approved" ? "bg-success-subtle text-success" : step.Status == "Denied" ? "bg-danger-subtle text-danger" : "bg-warning-subtle text-warning")">
                                    @(step.Status ?? "Pending Action")
                                </span>
                            </div>

                            <div class="pt-3 border-top mt-auto">
                                <form id="approverForm_@step.ID" asp-controller="Approval" asp-action="SetApproval" method="post">
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <input type="hidden" name="type" value="Locker" />
                                    <input type="hidden" name="approver" value="@step.ID" />
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <button type="button" onclick="submitApproverForm(@step.ID, 'Approved')" class="btn btn-approve w-100 btn-sm fw-bold py-2">APPROVE</button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" onclick="submitApproverForm(@step.ID, 'Denied')" class="btn btn-deny w-100 btn-sm fw-bold py-2">DENY</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-5 p-5 final-decision-box text-center">
                <h5 class="fw-bold mb-3">Administrative Confirmation</h5>
                <form asp-controller="Approval" asp-action="ConfirmApproval" method="post" class="mx-auto" style="max-width: 500px;">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="type" value="Locker" />

                    @if (Model.FinalStatus == "Denied")
                    {
                        <div class="mb-4 text-start">
                            <label class="form-label fw-bold text-danger small">REASON FOR DENIAL (REQUIRED)</label>
                            <textarea name="denialReason" class="form-control border-danger-subtle shadow-sm" rows="3" required placeholder="Explain why this locker request was denied...">@Model.DenialReasonLocker</textarea>
                        </div>
                    }

                    <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow fw-bold">
                        Confirm @Model.FinalStatus.ToUpper() Final Decision
                    </button>
                </form>
            </div>

            <div class="text-center mt-5">
                <a asp-action="Index" class="btn btn-link text-muted text-decoration-none small fw-bold">
                    <i class="bi bi-arrow-left me-2"></i>BACK TO DASHBOARD
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function saveScroll() { localStorage.setItem('lr_scroll', window.scrollY); }

    function submitApproverForm(approverId, decision) {
        saveScroll();
        const form = document.getElementById(`approverForm_${approverId}`);
        const existing = form.querySelector('input[name="decision"]');
        if(existing) existing.remove();

        let decisionInput = document.createElement("input");
        decisionInput.type = "hidden";
        decisionInput.name = "decision";
        decisionInput.value = decision;
        form.appendChild(decisionInput);
        form.submit();
    }

    (function() {
        const scrollPos = localStorage.getItem('lr_scroll');
        if (scrollPos) {
            window.scrollTo({ top: parseInt(scrollPos), behavior: 'instant' });
            localStorage.removeItem('lr_scroll');
        }
    })();
</script>