@model ELDNET.Models.ReservationRoom

@{
    ViewData["Title"] = "Activity Reservation Details";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link href="~/css/Approval/Reservation.css" rel="stylesheet" />
</head>

<div class="container py-5">
    <div class="modern-card animate__animated animate__fadeIn">
        <div class="glass-header d-flex justify-content-between align-items-center">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="#" class="text-white opacity-75 text-decoration-none">Room Reservation</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Details</li>
                    </ol>
                </nav>
                <h2 class="fw-bold mb-0">RR-@Model.Id.ToString("D5")</h2>
                <span class="opacity-75"><i class="bi bi-calendar-event me-2"></i>Requested on @Model.Date.ToString("MMMM dd, yyyy")</span>
            </div>
            <div class="text-end">
                <div class="mb-2 opacity-75 small fw-bold">OVERALL STATUS</div>
                <span class="status-pill @(Model.Status == "Approved" ? "bg-success" : Model.Status == "Denied" ? "bg-danger" : "bg-warning text-dark")">
                    @Model.Status
                </span>
            </div>
        </div>

        <div class="card-body p-4 p-lg-5">
            <div class="row g-4 mb-5">
                <div class="col-lg-8">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-info-circle text-primary"></i> Activity Details</div>
                                <div class="row">
                                    <div class="col-md-12 info-group">
                                        <div class="info-label">Activity Title</div>
                                        <div class="info-value fw-bold fs-5 text-primary">@Model.ActivityTitle</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Organization</div>
                                        <div class="info-value">@Model.OrganizationName</div>
                                    </div>
                                    <div class="col-md-6 info-group">
                                        <div class="info-label">Nature of Activity</div>
                                        <div class="info-value">@Model.NatureOfActivity</div>
                                    </div>
                                    <div class="col-md-12 info-group">
                                        <div class="info-label">Purpose / Objective</div>
                                        <div class="info-value">@Model.PurposeObjective</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-geo-alt text-primary"></i> Schedule & Logistics</div>
                                <div class="row">
                                    <div class="col-md-4 info-group">
                                        <div class="info-label">Venue / Room</div>
                                        <div class="info-value">@Model.Venue (@Model.RoomNumber)</div>
                                    </div>
                                    <div class="col-md-4 info-group">
                                        <div class="info-label">Activity Date</div>
                                        <div class="info-value fw-bold">@Model.ActivityDate.ToString("MMM dd, yyyy")</div>
                                    </div>
                                    <div class="col-md-4 info-group">
                                        <div class="info-label">Time Slot</div>
                                        <div class="info-value">@Model.TimeFrom.ToString(@"hh\:mm") - @Model.TimeTo.ToString(@"hh\:mm")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-person-badge text-primary"></i> Requester Information</div>
                                <div class="info-group">
                                    <div class="info-label">Full Name</div>
                                    <div class="info-value">@Model.ReservedBy</div>
                                </div>
                                <div class="info-group">
                                    <div class="info-label">Source of Funds</div>
                                    <div class="info-value">@Model.SourceOfFunds</div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="data-section">
                                <div class="section-label"><i class="bi bi-tools text-primary"></i> Equipment & Facilities</div>
                                <div class="info-value mb-3" style="white-space: pre-line;">
                                    @(string.IsNullOrEmpty(Model.EquipmentFacilities) ? "No special equipment requested." : Model.EquipmentFacilities)
                                </div>

                                @if (!string.IsNullOrEmpty(Model.DenialReasonReservation))
                                {
                                    <div class="mt-4 p-3 rounded-3 bg-danger-subtle border border-danger-subtle text-danger">
                                        <div class="fw-bold small mb-1"><i class="bi bi-exclamation-octagon-fill"></i> REASON FOR DENIAL</div>
                                        <div class="small">@Model.DenialReasonReservation</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="section-label mb-4 text-center justify-content-center">
                    <i class="bi bi-diagram-3 text-primary"></i> Approval Workflow & Actions
                </div>

                @{
                    var allStages = new[] {
                                new { ID = 1, Name = "Atty. Virgil B. Villanueva", Pos = "SAO Director", Status = Model.Approver1Status },
                                new { ID = 2, Name = "Ms. Mercy Apuhin", Pos = "Department Head", Status = Model.Approver2Status },
                                new { ID = 3, Name = "Ofelia G. Moho", Pos = "Campus Director", Status = Model.Approver3Status },
                                new { ID = 4, Name = "Engr. Jessie Flores", Pos = "Building Officer", Status = Model.Approver4Status },
                                new { ID = 5, Name = "Eduardo Jones", Pos = "Head Guard", Status = Model.Approver5Status }
                                };
                }

                <div class="row g-4 justify-content-center">
                    @foreach (var stage in allStages)
                    {
                        var cardClass = stage.Status == "Approved" ? "approved" : (stage.Status == "Denied" ? "denied" : "pending active-stage");
                        var statusIcon = stage.Status == "Approved" ? "bi-check-circle-fill text-success" : (stage.Status == "Denied" ? "bi-x-circle-fill text-danger" : "bi-clock-history text-warning");

                        <div class="col-lg-4 col-md-6">
                            <div class="approver-card @cardClass shadow-sm d-flex flex-column h-100">
                                <div class="stage-badge">STAGE @stage.ID</div>
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi @statusIcon fs-4 me-2"></i>
                                    <div>
                                        <div class="fw-bold text-dark">@stage.Name</div>
                                        <span class="approver-position">@stage.Pos</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <span class="small text-muted d-block">Current Status:</span>
                                    <span class="badge @(stage.Status == "Approved" ? "bg-success-subtle text-success" : stage.Status == "Denied" ? "bg-danger-subtle text-danger" : "bg-warning-subtle text-warning")">
                                        @(stage.Status ?? "Pending Action")
                                    </span>
                                </div>

                                <div class="pt-3 border-top mt-auto">
                                    <form id="approverForm_@stage.ID" asp-controller="Approval" asp-action="SetApproval" method="post">
                                        <input type="hidden" name="id" value="@Model.Id" />
                                        <input type="hidden" name="type" value="Reservation" />
                                        <input type="hidden" name="approver" value="@stage.ID" />
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <button type="button" onclick="submitApproverForm(@stage.ID, 'Approved')" class="btn btn-approve w-100 btn-sm fw-bold py-2">APPROVE</button>
                                            </div>
                                            <div class="col-6">
                                                <button type="button" onclick="submitApproverForm(@stage.ID, 'Denied')" class="btn btn-deny w-100 btn-sm fw-bold py-2">DENY</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="mt-5 p-5 final-decision-box text-center">
                <h5 class="fw-bold mb-3">Administrative Confirmation</h5>
                <form asp-controller="Approval" asp-action="ConfirmApproval" method="post" class="mx-auto" style="max-width: 500px;">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <input type="hidden" name="type" value="Reservation" />

                    @if (Model.FinalStatus == "Denied")
                    {
                        <div class="mb-4 text-start">
                            <label class="form-label fw-bold text-danger small">REASON FOR DENIAL (REQUIRED)</label>
                            <textarea name="denialReason" class="form-control border-danger-subtle shadow-sm" rows="3" required placeholder="Explain why this reservation was denied...">@Model.DenialReasonReservation</textarea>
                        </div>
                    }

                    <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow fw-bold">
                        Confirm @Model.FinalStatus.ToUpper() Final Decision
                    </button>
                </form>
            </div>

            <div class="text-center mt-5">
                <a asp-action="Index" class="btn btn-link text-muted text-decoration-none small fw-bold">
                    <i class="bi bi-arrow-left me-2"></i>BACK TO RESERVATION LIST
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function saveScroll() { localStorage.setItem('res_scroll', window.scrollY); }

    function submitApproverForm(approverId, decision) {
        saveScroll();
        const form = document.getElementById(`approverForm_${approverId}`);
        const existing = form.querySelector('input[name="decision"]');
        if(existing) existing.remove();

        let decisionInput = document.createElement("input");
        decisionInput.type = "hidden";
        decisionInput.name = "decision";
        decisionInput.value = decision;
        form.appendChild(decisionInput);
        form.submit();
    }

    (function() {
        const scrollPos = localStorage.getItem('res_scroll');
        if (scrollPos) {
            window.scrollTo({ top: parseInt(scrollPos), behavior: 'instant' });
            localStorage.removeItem('res_scroll');
        }
    })();
</script>